# Render.yaml Validation Guide

## Validating Render Configuration

### Method 1: GitHub Push (Automatic Validation)
```bash
# Render validates syntax automatically when you push
git add render.yaml
git commit -m "Update render configuration"
git push origin main
```
Then check your Render dashboard for validation errors.

### Method 2: Render CLI (Local Validation)
```bash
# Install Render CLI
npm install -g @render-inc/cli

# Login to Render
render login

# Validate the blueprint
render blueprint validate
```

### Method 3: Manual Schema Check
Compare against [Render Blueprint Spec](https://render.com/docs/blueprint-spec)

## Key Issues Fixed

### 1. Repository URL Format
- Before: `repo: github.com/tarektarho/novi-devops-2025`
- After: `repo: https://github.com/tarektarho/novi-devops-2025`
- Why: Render requires full HTTPS URL

### 2. DEPLOYED_AT Environment Variable
- Before: Used `generateValue: true` (incorrect - this is for secrets)
- After: Removed and replaced with `BUILD_TIME` via buildCommand
- Why: `generateValue` creates random strings, not timestamps
- Fix: Use build command to set dynamic values

### 3. Missing Critical Configurations
Added:
- `region: frankfurt` - EU data compliance
- `dockerfilePath` and `dockerContext` - Explicit paths
- `numInstances: 1` - Resource allocation
- `buildCommand` - Set dynamic environment variables

## Testing Checklist

### Pre-Deployment
- [ ] Dockerfile builds successfully locally
  ```bash
  docker build -t test-build .
  docker run -p 3000:3000 test-build
  ```

- [ ] Health endpoint returns 200 OK
  ```bash
  curl http://localhost:3000/health
  ```

- [ ] App listens on PORT environment variable
  ```bash
  PORT=10000 npm start
  curl http://localhost:10000/health
  ```

### Post-Deployment
- [ ] Service starts successfully in Render dashboard
- [ ] Health checks pass (green status)
- [ ] Logs show no critical errors
- [ ] Public URL responds correctly
- [ ] Environment variables are set correctly

## Common Issues

### Failed to build Docker image
Test Dockerfile locally first:
```bash
docker build -t render-test .
```

### Service failed health checks
Ensure:
1. App listens on `process.env.PORT` (not hardcoded 3000)
2. `/health` endpoint returns 200 OK
3. App starts within 5 minutes

### Environment variable not set
Check:
1. Variable name matches exactly (case-sensitive)
2. No typos in render.yaml
3. For dynamic values, use buildCommand instead of generateValue

## üìä Render Free Plan Limitations

| Feature | Free Plan | Paid Plans |
|---------|-----------|------------|
| Instances | 1 | Multiple |
| Auto-scaling | ‚ùå | ‚úÖ |
| Sleep after inactivity | ‚úÖ (15 min) | ‚ùå |
| Build minutes | 400/month | Unlimited |
| Bandwidth | 100 GB/month | Unlimited |

## üîÑ Deployment Workflow

1. **Code Change** ‚Üí Push to `main` branch
2. **Auto-Deploy Trigger** ‚Üí Render detects commit
3. **Build Phase**:
   - Pulls repository
   - Runs `buildCommand` (sets BUILD_TIME)
   - Builds Docker image from Dockerfile
4. **Deploy Phase**:
   - Starts container
   - Waits for health checks
   - Routes traffic to new version
5. **Health Monitoring** ‚Üí Continuous checks on `/health`

## Best Practices

- Infrastructure as code (configuration version controlled)
- Auto-deployment (CI/CD integration)
- Health checks (automatic failure detection)
- Region selection (EU compliance - Frankfurt)
- Explicit runtime (Docker for consistency)
- Environment separation (production-only config)

## üìù Next Steps for Production

1. **Add Database** (if needed):
   ```yaml
   databases:
     - name: novi-postgres
       databaseName: novi_db
       user: novi_user
       plan: free
   ```

2. **Add Background Workers** (if needed):
   ```yaml
   - type: worker
     name: novi-worker
     runtime: docker
     repo: https://github.com/tarektarho/novi-devops-2025
     dockerCommand: node dist/worker.js
   ```

3. **Add Environment Groups** for shared variables across services

4. **Set up Notifications** in Render dashboard for deployment failures

## üîó Useful Links

- [Render Blueprint Spec](https://render.com/docs/blueprint-spec)
- [Render Health Checks](https://render.com/docs/health-checks)
- [Docker Deployment](https://render.com/docs/docker)
- [Environment Variables](https://render.com/docs/environment-variables)
